<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan Ingredients</title>
    <link rel="stylesheet" href="scan.css">
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>
<body>
    <nav>
        <div class="nav-brand">FeasTapp</div>
        <ul class="nav-links">
            <li><a href="/main/main.html">Home</a></li>
            <li><a href="#about">About</a></li>
            <li><a href="/scan/scan.html">Scan</a></li>
            <li><a href="/chatbot/chatbot.html">Chatbot</a></li>
            <div class="dropdown">
                <button class="dropbtn">
                    <i class="fas fa-bars"></i> <!-- FontAwesome icon for menu -->
                </button>
                <div class="dropdown-content">
                    <a href="#profile">User Profile</a>
                    <a href="#settings">Settings</a>
                    <a href="#logout">Logout</a>
                </div>
            </div>
        </ul>
        
        </div>
    </nav>
    <div class="scan-container">
        <div class="scan-box">
            <img src="https://cdn-icons-png.flaticon.com/512/2722/2722110.png" alt="Scan Icon" class="scan-icon">
            <h1>SCAN INGREDIENTS</h1>
            <p>All your photos will automatically be saved to the database.</p>
            <button id="camera-btn">Access Camera</button>
            <button id="upload-btn">Upload Photos</button>
            <input type="file" id="uploadInput" accept="image/*" hidden>

           <canvas id="canvas" width="640" height="480"></canvas> 
            <div id="ingredientList"></div> <!-- Closed the div tag -->
            
            <!-- Container for video and close button -->
            <div class="video-container" hidden>
                <button id="close-camera-btn">&times;</button> <!-- Styling as 'X' -->
                <video id="video" width="640" height="480" autoplay hidden></video>
                <button id="captureAndDetectButton">Take Snapshot</button>
            </div> 
        </div>
    </div>
    <script>document.addEventListener('DOMContentLoaded', function() {
        var video = document.getElementById('video');
        var cameraButton = document.getElementById('camera-btn');
        var closeCameraButton = document.getElementById('close-camera-btn');
        var videoContainer = document.querySelector('.video-container');
        var uploadInput = document.getElementById('uploadInput');
        var canvas = document.getElementById('canvas');
    
        cameraButton.addEventListener('click', function() {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(function(stream) {
                    video.srcObject = stream;
                    video.play();
                    video.removeAttribute('hidden');
                    videoContainer.style.display = 'block';
                    closeCameraButton.style.display = 'block';
                })
                .catch(function(error) {
                    console.error("Error accessing the camera: ", error);
                    alert('Unable to access camera: ' + error.message);
                });
        });
    
        uploadInput.addEventListener("change", async (event) => {
            // Your upload input logic here...
        });
    
        closeCameraButton.addEventListener('click', function() {
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            video.setAttribute('hidden', true);
            videoContainer.style.display = 'none';
            closeCameraButton.style.display = 'none';
        });
    
        const captureAndDetectButton = document.getElementById("captureAndDetectButton");
        captureAndDetectButton.addEventListener("click", () => {
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            canvas.toBlob(async function(blob) {
                const formData = new FormData();
                formData.append('image_file', blob, 'snapshot.jpg');
    
                const response = await fetch('/detect', {
                    method: 'POST',
                    body: formData
                });
                const boxes = await response.json();
                draw_image_and_boxes(blob, boxes);
                list_detected_ingredients(boxes);
            }, 'image/jpeg');
        });
    
        const uploadButton = document.getElementById("upload-btn");
        uploadButton.addEventListener("click", () => {
            const input = document.getElementById("uploadInput");
            input.click();
        });
    
        // Function to draw an image and bounding boxes on a canvas based on the provided file and boxes array.
        function draw_image_and_boxes(file, boxes) {
            const img = new Image();
            img.src = URL.createObjectURL(file);
            img.onload = () => {
                const ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0);
                ctx.strokeStyle = "#00FF00";
                ctx.lineWidth = 3;
                ctx.font = "18px serif";
                boxes.forEach(([x1, y1, x2, y2, label]) => {
                    ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);
                    ctx.fillStyle = "#00ff00";
                    const width = ctx.measureText(label).width;
                    ctx.fillRect(x1, y1, width + 10, 25);
                    ctx.fillStyle = "#000000";
                    ctx.fillText(label, x1, y1 + 18);
                });
            };
        }
    
        function list_detected_ingredients(boxes) {
            const ingredientList = document.getElementById("ingredientList");
            ingredientList.innerHTML = "";
            const uniqueIngredients = new Set();
            boxes.forEach(([x1, y1, x2, y2, label]) => {
                uniqueIngredients.add(label);
            });
            uniqueIngredients.forEach(ingredient => {
                const ingredientListItem = document.createElement("p");
                ingredientListItem.textContent = ingredient;
                ingredientList.appendChild(ingredientListItem);
            });
        }
    });
    
    </script>
    
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FeastApp</title>
  <style>
    canvas {
      display: block;
      border: 1px solid black;
      margin-top: 10px;
    }
    #ingredientList {
      margin-top: 20px;
    }
    #buttonContainer {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div id="buttonContainer">
    <button id="captureButton">Capture Image</button>
    <input id="uploadInput" type="file" accept="image/*" style="display: none;" />
    <button id="uploadButton">Upload Image</button>
    <button id="captureAndDetectButton">Capture & Detect</button>
  </div>

  <input id="u  ploadInput" type="file"/> 
  <canvas></canvas>
  <div id="ingredientList"></div> <!-- Add a section to display detected ingredients -->

  <script>
    const input = document.getElementById("uploadInput");
    input.addEventListener("change", async (event) => {
      const file = event.target.files[0];
      const data = new FormData();
      data.append("image_file", file, "image_file");
      const response = await fetch("/detect", {
        method: "post",
        body: data
      }); 
      const boxes = await response.json();
      draw_image_and_boxes(file, boxes);
      list_detected_ingredients(boxes);
    });

    const captureButton = document.getElementById("captureButton");
    captureButton.addEventListener("click", () => {
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      const video = document.createElement("video");
      document.body.appendChild(video);

      navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
          video.srcObject = stream;
          video.play();
        })
        .catch(err => {
          console.error("Error accessing camera:", err);
        });

      video.addEventListener("loadedmetadata", () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = canvas.toDataURL("image/jpeg");
        const blobBin = atob(imageData.split(",")[1]);
        const array = [];
        for (let i = 0; i < blobBin.length; i++) {
          array.push(blobBin.charCodeAt(i));
        }
        const file = new Blob([new Uint8Array(array)], { type: "image/jpeg" });
        draw_image_and_boxes(file, []);
        document.body.removeChild(video);
      });
    });

    const captureAndDetectButton = document.getElementById("captureAndDetectButton");
    captureAndDetectButton.addEventListener("click", () => {
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      const video = document.createElement("video");
      document.body.appendChild(video);

      navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
          video.srcObject = stream;
          video.play();
        })
        .catch(err => {
          console.error("Error accessing camera:", err);
        });

      video.addEventListener("loadedmetadata", () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = canvas.toDataURL("image/jpeg");
        const blobBin = atob(imageData.split(",")[1]);
        const array = [];
        for (let i = 0; i < blobBin.length; i++) {
          array.push(blobBin.charCodeAt(i));
        }
        const file = new Blob([new Uint8Array(array)], { type: "image/jpeg" });
        const data = new FormData();
        data.append("image_file", file, "image_file");
        fetch("/detect", {
          method: "post",
          body: data
        })
        .then(response => response.json())
        .then(boxes => {
          draw_image_and_boxes(file, boxes);
          list_detected_ingredients(boxes);
        });
        document.body.removeChild(video);
      });
    });

    const uploadButton = document.getElementById("uploadButton");
    uploadButton.addEventListener("click", () => {
      const input = document.getElementById("uploadInput");
      input.click();
    });

    // Function to draw an image and bounding boxes on a canvas based on the provided file and boxes array.
    function draw_image_and_boxes(file, boxes) {
      const img = new Image();
      img.src = URL.createObjectURL(file);
      img.onload = () => {
        const canvas = document.querySelector("canvas");
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0);
        ctx.strokeStyle = "#00FF00";
        ctx.lineWidth = 3;
        ctx.font = "18px serif";
        boxes.forEach(([x1, y1, x2, y2, label]) => {
          ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);
          ctx.fillStyle = "#00ff00";
          const width = ctx.measureText(label).width;
          ctx.fillRect(x1, y1, width + 10, 25);
          ctx.fillStyle = "#000000";
          ctx.fillText(label, x1, y1 + 18);
        });
      };
    }

    function list_detected_ingredients(boxes) {
      const ingredientList = document.getElementById("ingredientList");
      ingredientList.innerHTML = "";
      const uniqueIngredients = new Set();
      boxes.forEach(([x1, y1, x2, y2, label]) => {
        uniqueIngredients.add(label);
      });
      uniqueIngredients.forEach(ingredient => {
        const ingredientListItem = document.createElement("p");
        ingredientListItem.textContent = ingredient;
        ingredientList.appendChild(ingredientListItem);
      });
    }
  </script>
</body>
</html>